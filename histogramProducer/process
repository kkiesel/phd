#!/bin/bash -e

# start jobs and run them in parallel

#case "$1" in
#
#qcd)
#  infiles=(
#    /user/kiesel/nTuples/2015-07-20/QCD_HT300to500.root
#    /user/kiesel/nTuples/2015-07-20/QCD_HT500to700.root
#    /user/kiesel/nTuples/2015-07-20/QCD_HT700to1000.root
#    /user/kiesel/nTuples/2015-07-20/QCD_HT1000to1500.root
#    /user/kiesel/nTuples/2015-07-20/QCD_HT1500to2000.root
#    /user/kiesel/nTuples/2015-07-20/QCD_HT2000toInf.root
#  )
#;;
#
#gjets)
#  infiles=(
#    /user/kiesel/nTuples/2015-07-20/GJets_HT-400To600.root
#    /user/kiesel/nTuples/2015-07-20/GJets_HT-600ToInf.root
#  )
#;;
#
#ewk)
#  infiles=(
#    /user/kiesel/nTuples/2015-07-20/WJetsToLNu_HT-400To600.root
#    /user/kiesel/nTuples/2015-07-20/WJetsToLNu_HT-600ToInf.root
#    /user/kiesel/nTuples/2015-07-20/TTJets.root
#  )
#;;
#
#isr)
#  infiles=(
#    /user/kiesel/nTuples/2015-07-20/TTGJets.root
#  )
#;;
#signal)
#  infiles=(
#    /user/kiesel/nTuples/2015-07-20/T2ttgg_850_200.root
#    /user/kiesel/nTuples/2015-07-20/T5gg_1500_1000.root
#    /user/kiesel/nTuples/2015-07-20/T5hg_1500_1000.root
#  )
#;;
#*)
#  echo "Does not know what you want"
#  exit 1
#
#esac

infiles=(
  /user/kiesel/nTuples/2015-07-20/QCD_HT300to500.root
  /user/kiesel/nTuples/2015-07-20/QCD_HT500to700.root
  /user/kiesel/nTuples/2015-07-20/QCD_HT700to1000.root
  /user/kiesel/nTuples/2015-07-20/QCD_HT1000to1500.root
  /user/kiesel/nTuples/2015-07-20/QCD_HT1500to2000.root
  /user/kiesel/nTuples/2015-07-20/QCD_HT2000toInf.root
  /user/kiesel/nTuples/2015-07-20/GJets_HT-400To600.root
  /user/kiesel/nTuples/2015-07-20/GJets_HT-600ToInf.root
  /user/kiesel/nTuples/2015-07-20/WJetsToLNu_HT-400To600.root
  /user/kiesel/nTuples/2015-07-20/WJetsToLNu_HT-600ToInf.root
  /user/kiesel/nTuples/2015-07-20/TTJets.root
  /user/kiesel/nTuples/2015-07-20/TTGJets.root
  /user/kiesel/nTuples/2015-07-20/T2ttgg_850_200.root
  /user/kiesel/nTuples/2015-07-20/T5gg_1500_1000.root
  /user/kiesel/nTuples/2015-07-20/T5hg_1500_1000.root
)


# run with no input file first, to compile all versions
root -b -l -q run.C\(\"0\"\)

nCores=5

while [ ${#infiles[@]} -ne 0 ]; do
  sleep 1

  # find out how many root processer are running
  nProcRunning=$(ps hu -C "root -b -l -q run.C"|wc -l)
  if [ "$nProcRunning" -lt "$nCores" ]; then
    root -b -l -q run.C\(\"${infiles[0]}\"\) &
    infiles=( ${infiles[@]:1:99} )
  fi

done

